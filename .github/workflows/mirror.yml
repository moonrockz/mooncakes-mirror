name: Mirror Mooncakes Registry

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      full_mirror:
        description: 'Perform a full mirror of all packages'
        type: boolean
        required: false
        default: true

# Allow only one mirror operation at a time
concurrency:
  group: mirror-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone mooncakes.io index
        run: |
          echo "Cloning mooncakes.io index repository..."
          git clone --depth 1 https://mooncakes.io/git/index mooncakes-index
          echo "Index cloned successfully"

          # Show some stats
          echo "=== Index contents ==="
          ls -la mooncakes-index/
          if [ -d "mooncakes-index/user" ]; then
            OWNER_COUNT=$(find mooncakes-index/user -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
            PACKAGE_COUNT=$(find mooncakes-index/user -name "*.index" -type f 2>/dev/null | wc -l)
            echo "Found $PACKAGE_COUNT packages from $OWNER_COUNT publishers"
          fi

      - name: Generate statistics
        id: stats
        run: |
          LAST_SYNC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TOTAL_PACKAGES=0
          TOTAL_OWNERS=0
          YANKED_COUNT=0

          SOURCE_INDEX="mooncakes-index/user"
          if [ -d "$SOURCE_INDEX" ]; then
            TOTAL_OWNERS=$(find "$SOURCE_INDEX" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
            TOTAL_PACKAGES=$(find "$SOURCE_INDEX" -name "*.index" -type f 2>/dev/null | wc -l)
          fi

          # Count yanked/deprecated packages and generate yanked.json
          echo "Scanning for yanked/deprecated packages..."
          YANKED_JSON='{"yankedPackages":['
          FIRST=true

          if [ -d "$SOURCE_INDEX" ]; then
            while IFS= read -r index_file; do
              while IFS= read -r line; do
                if echo "$line" | grep -qE '"yanked"[[:space:]]*:[[:space:]]*true|"deprecated"[[:space:]]*:'; then
                  YANKED_COUNT=$((YANKED_COUNT + 1))
                  PKG_NAME=$(echo "$line" | grep -oP '"name"[[:space:]]*:[[:space:]]*"\K[^"]+' || echo "")
                  PKG_VERSION=$(echo "$line" | grep -oP '"version"[[:space:]]*:[[:space:]]*"\K[^"]+' || echo "")
                  PKG_REASON=$(echo "$line" | grep -oP '"deprecated"[[:space:]]*:[[:space:]]*"\K[^"]+' || echo "yanked")
                  if [ -n "$PKG_NAME" ] && [ -n "$PKG_VERSION" ]; then
                    if [ "$FIRST" = true ]; then
                      FIRST=false
                    else
                      YANKED_JSON="$YANKED_JSON,"
                    fi
                    PKG_REASON_ESCAPED=$(echo "$PKG_REASON" | sed 's/"/\\"/g')
                    YANKED_JSON="$YANKED_JSON{\"name\":\"$PKG_NAME\",\"version\":\"$PKG_VERSION\",\"reason\":\"$PKG_REASON_ESCAPED\"}"
                  fi
                fi
              done < "$index_file"
            done < <(find "$SOURCE_INDEX" -name "*.index" -type f 2>/dev/null)
          fi

          YANKED_JSON="$YANKED_JSON],\"count\":$YANKED_COUNT,\"generatedAt\":\"$LAST_SYNC\"}"
          mkdir -p registry-data
          echo "$YANKED_JSON" | jq '.' > registry-data/yanked.json 2>/dev/null || echo "$YANKED_JSON" > registry-data/yanked.json

          echo "Found $YANKED_COUNT yanked/deprecated package versions"

          # Generate JSON stats file
          cat > registry-data/stats.json << STATSEOF
          {
            "lastSync": "$LAST_SYNC",
            "totalPackages": $TOTAL_PACKAGES,
            "totalOwners": $TOTAL_OWNERS,
            "yankedCount": $YANKED_COUNT,
            "source": "mooncakes.io",
            "mirrorUrl": "https://moonrockz.github.io/mooncakes-mirror"
          }
          STATSEOF

          echo "Registry Statistics:"
          cat registry-data/stats.json

          echo "packages=$TOTAL_PACKAGES" >> $GITHUB_OUTPUT
          echo "owners=$TOTAL_OWNERS" >> $GITHUB_OUTPUT

      - name: Prepare registry branch content
        run: |
          mkdir -p registry-content/git/index

          # Copy the index (excluding .git directory to avoid nested repo issues)
          rsync -av --exclude='.git' mooncakes-index/ registry-content/git/index/

          # Initialize git and enable dumb HTTP protocol
          cd registry-content/git/index
          git init
          git add -A
          git commit -m "Index snapshot $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          git update-server-info
          cd ../../..

          # Copy stats files
          cp registry-data/stats.json registry-content/
          cp registry-data/yanked.json registry-content/

          echo "=== Registry content prepared ==="
          find registry-content -type f | head -20

      - name: Push to registry branch
        run: |
          cd registry-content
          git init
          git add -A
          git commit -m "Mirror update - ${{ steps.stats.outputs.packages }} packages, ${{ steps.stats.outputs.owners }} publishers"
          git branch -M registry
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -f origin registry
          echo "Pushed to registry branch successfully"

      - name: Summary
        run: |
          echo "## Mirror Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Packages**: ${{ steps.stats.outputs.packages }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Publishers**: ${{ steps.stats.outputs.owners }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`registry\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The pages workflow will automatically deploy the updated mirror." >> $GITHUB_STEP_SUMMARY
