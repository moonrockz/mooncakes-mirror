name: Mirror Mooncakes Registry

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      pattern:
        description: 'Package pattern to mirror (e.g., "moonbitlang/*" or leave empty for full mirror)'
        required: false
        default: ''
      full_mirror:
        description: 'Perform a full mirror of all packages'
        type: boolean
        required: false
        default: false

# Allow only one mirror operation at a time
concurrency:
  group: mirror-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          install: true
      
      - name: Install moonbit-registry-tools
        run: mise use -g "github:moonrockz/moonbit-registry-tools@latest"
      
      - name: Verify moonbit-registry installation
        run: moonbit-registry --version || moonbit-registry -v || echo "Version command not available"
      
      - name: Initialize registry (if needed)
        run: |
          if [ ! -d "data/index" ]; then
            moonbit-registry init --name mooncakes-mirror
          fi
      
      - name: Configure Git for index updates
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Capture pre-sync counts
        id: pre-sync
        run: |
          PACKAGE_COUNT=0
          OWNER_COUNT=0
          if [ -d "data/index" ]; then
            cd data/index
            OWNER_COUNT=$(find . -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
            PACKAGE_COUNT=$(find . -mindepth 2 -maxdepth 2 -type d 2>/dev/null | wc -l)
            cd ../..
          fi
          echo "packages=$PACKAGE_COUNT" >> $GITHUB_OUTPUT
          echo "owners=$OWNER_COUNT" >> $GITHUB_OUTPUT
          echo "Pre-sync: $PACKAGE_COUNT packages, $OWNER_COUNT owners"

      - name: Mirror packages (Full)
        if: ${{ github.event.inputs.full_mirror == 'true' }}
        run: |
          echo "Performing full mirror of mooncakes registry..."
          moonbit-registry mirror --full

      - name: Mirror packages (Pattern)
        if: ${{ github.event.inputs.full_mirror != 'true' && github.event.inputs.pattern != '' }}
        run: |
          echo "Mirroring packages matching pattern: ${{ github.event.inputs.pattern }}"
          moonbit-registry mirror "${{ github.event.inputs.pattern }}"

      - name: Mirror packages (Default - moonbitlang on schedule)
        if: ${{ github.event_name == 'schedule' }}
        run: |
          echo "Mirroring moonbitlang packages (scheduled run)..."
          moonbit-registry mirror "moonbitlang/*"

      - name: Debug - Check source index contents
        run: |
          echo "=== Checking source index ==="
          ls -la data/index/sources/mooncakes/ 2>/dev/null || echo "Directory does not exist"
          echo "=== Checking for user directory ==="
          ls -la data/index/sources/mooncakes/user/ 2>/dev/null || echo "user/ does not exist"
          echo "=== Git status in source index ==="
          cd data/index/sources/mooncakes && git status && git log --oneline -3 && cd ../../../..

      - name: Mirror packages (Default - moonbitlang on manual trigger)
        if: ${{ github.event.inputs.full_mirror != 'true' && github.event.inputs.pattern == '' && github.event_name == 'workflow_dispatch' }}
        run: |
          echo "Mirroring moonbitlang packages..."
          moonbit-registry mirror "moonbitlang/*" --verbose
      
      - name: Generate registry statistics
        run: |
          LAST_SYNC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TOTAL_PACKAGES=0
          TOTAL_OWNERS=0
          YANKED_COUNT=0

          # Count total packages and owners in the index
          if [ -d "data/index" ]; then
            cd data/index
            TOTAL_OWNERS=$(find . -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
            TOTAL_PACKAGES=$(find . -mindepth 2 -maxdepth 2 -type d 2>/dev/null | wc -l)
            cd ../..
          fi

          # Calculate sync deltas
          PRE_PACKAGES=${{ steps.pre-sync.outputs.packages }}
          PRE_OWNERS=${{ steps.pre-sync.outputs.owners }}
          SYNC_PACKAGES=$((TOTAL_PACKAGES - PRE_PACKAGES))
          SYNC_OWNERS=$((TOTAL_OWNERS - PRE_OWNERS))

          # Count yanked packages and generate yanked.json
          echo "Scanning for yanked packages..."
          YANKED_JSON='{"yankedPackages":['
          FIRST=true

          # Find all .index files in the source index
          SOURCE_INDEX="data/index/sources/mooncakes/user"
          if [ -d "$SOURCE_INDEX" ]; then
            while IFS= read -r index_file; do
              # Parse each line of the JSONL file for yanked entries
              while IFS= read -r line; do
                if echo "$line" | grep -q '"yanked"[[:space:]]*:[[:space:]]*true'; then
                  YANKED_COUNT=$((YANKED_COUNT + 1))
                  # Extract name and version
                  PKG_NAME=$(echo "$line" | grep -oP '"name"[[:space:]]*:[[:space:]]*"\K[^"]+' || echo "")
                  PKG_VERSION=$(echo "$line" | grep -oP '"version"[[:space:]]*:[[:space:]]*"\K[^"]+' || echo "")
                  if [ -n "$PKG_NAME" ] && [ -n "$PKG_VERSION" ]; then
                    if [ "$FIRST" = true ]; then
                      FIRST=false
                    else
                      YANKED_JSON="$YANKED_JSON,"
                    fi
                    YANKED_JSON="$YANKED_JSON{\"name\":\"$PKG_NAME\",\"version\":\"$PKG_VERSION\"}"
                  fi
                fi
              done < "$index_file"
            done < <(find "$SOURCE_INDEX" -name "*.index" -type f 2>/dev/null)
          fi

          YANKED_JSON="$YANKED_JSON],\"count\":$YANKED_COUNT,\"generatedAt\":\"$LAST_SYNC\"}"
          echo "$YANKED_JSON" | jq '.' > data/yanked.json 2>/dev/null || echo "$YANKED_JSON" > data/yanked.json

          echo "Found $YANKED_COUNT yanked package versions"

          # Generate JSON stats file
          cat > data/stats.json << STATSEOF
          {
            "lastSync": "$LAST_SYNC",
            "totalPackages": $TOTAL_PACKAGES,
            "totalOwners": $TOTAL_OWNERS,
            "yankedCount": $YANKED_COUNT,
            "lastSyncPackages": $SYNC_PACKAGES,
            "lastSyncOwners": $SYNC_OWNERS,
            "source": "mooncakes.io",
            "mirrorUrl": "https://moonrockz.github.io/mooncakes-mirror"
          }
          STATSEOF

          # Pretty print for logs
          echo "Registry Statistics:"
          cat data/stats.json
          echo ""
          echo "This sync added $SYNC_PACKAGES packages and $SYNC_OWNERS publishers"

      - name: Commit and push all updates
        run: |
          git add data/index/ data/stats.json data/yanked.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update registry index and stats - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            git push origin main
          fi
