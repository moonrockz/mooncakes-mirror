name: Mirror Mooncakes Registry

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:

# Allow only one mirror operation at a time
concurrency:
  group: mirror
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout registry-index branch
        uses: actions/checkout@v4
        with:
          ref: registry-index
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://mooncakes.io/git/index || true
          git remote -v

      - name: Pull from upstream
        run: |
          echo "Pulling latest changes from mooncakes.io..."
          git fetch upstream main
          git merge upstream/main --no-edit -m "Sync with mooncakes.io $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "Sync complete"

      - name: Generate statistics
        id: stats
        run: |
          LAST_SYNC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TOTAL_PACKAGES=0
          TOTAL_OWNERS=0
          YANKED_COUNT=0

          if [ -d "user" ]; then
            TOTAL_OWNERS=$(find user -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
            TOTAL_PACKAGES=$(find user -name "*.index" -type f 2>/dev/null | wc -l)
          fi

          # Count yanked/deprecated packages and generate yanked.json
          echo "Scanning for yanked/deprecated packages..."
          YANKED_JSON='{"yankedPackages":['
          FIRST=true

          if [ -d "user" ]; then
            while IFS= read -r index_file; do
              while IFS= read -r line; do
                if echo "$line" | grep -qE '"yanked"[[:space:]]*:[[:space:]]*true|"deprecated"[[:space:]]*:'; then
                  YANKED_COUNT=$((YANKED_COUNT + 1))
                  PKG_NAME=$(echo "$line" | grep -oP '"name"[[:space:]]*:[[:space:]]*"\K[^"]+' || echo "")
                  PKG_VERSION=$(echo "$line" | grep -oP '"version"[[:space:]]*:[[:space:]]*"\K[^"]+' || echo "")
                  PKG_REASON=$(echo "$line" | grep -oP '"deprecated"[[:space:]]*:[[:space:]]*"\K[^"]+' || echo "yanked")
                  if [ -n "$PKG_NAME" ] && [ -n "$PKG_VERSION" ]; then
                    if [ "$FIRST" = true ]; then
                      FIRST=false
                    else
                      YANKED_JSON="$YANKED_JSON,"
                    fi
                    PKG_REASON_ESCAPED=$(echo "$PKG_REASON" | sed 's/"/\\"/g')
                    YANKED_JSON="$YANKED_JSON{\"name\":\"$PKG_NAME\",\"version\":\"$PKG_VERSION\",\"reason\":\"$PKG_REASON_ESCAPED\"}"
                  fi
                fi
              done < "$index_file"
            done < <(find user -name "*.index" -type f 2>/dev/null)
          fi

          YANKED_JSON="$YANKED_JSON],\"count\":$YANKED_COUNT,\"generatedAt\":\"$LAST_SYNC\"}"
          echo "$YANKED_JSON" | jq '.' > yanked.json 2>/dev/null || echo "$YANKED_JSON" > yanked.json

          echo "Found $YANKED_COUNT yanked/deprecated package versions"

          # Generate JSON stats file
          cat > stats.json << STATSEOF
          {
            "lastSync": "$LAST_SYNC",
            "totalPackages": $TOTAL_PACKAGES,
            "totalOwners": $TOTAL_OWNERS,
            "yankedCount": $YANKED_COUNT,
            "source": "mooncakes.io",
            "mirrorUrl": "https://moonrockz.github.io/mooncakes-mirror"
          }
          STATSEOF

          echo "Registry Statistics:"
          cat stats.json

          echo "packages=$TOTAL_PACKAGES" >> $GITHUB_OUTPUT
          echo "owners=$TOTAL_OWNERS" >> $GITHUB_OUTPUT

      - name: Commit and push
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Mirror update - ${{ steps.stats.outputs.packages }} packages, ${{ steps.stats.outputs.owners }} publishers"
            git push origin registry-index
            echo "Pushed to registry-index branch"
          fi

      - name: Summary
        run: |
          echo "## Mirror Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Packages**: ${{ steps.stats.outputs.packages }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Publishers**: ${{ steps.stats.outputs.owners }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`registry-index\`" >> $GITHUB_STEP_SUMMARY
